{
  "version": 3,
  "file": "packager.js",
  "sourceRoot": "",
  "sources": [
    "../src/packager.ts"
  ],
  "names": [],
  "mappings": "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",
  "sourcesContent": [
    "import * as path from \"path\"\nimport { computeDefaultAppDirectory, installDependencies, log, getElectronVersion, readPackageJson, use, warn } from \"./util\"\nimport { all, executeFinally } from \"./promise\"\nimport { EventEmitter } from \"events\"\nimport { Promise as BluebirdPromise } from \"bluebird\"\nimport { InfoRetriever } from \"./repositoryInfo\"\nimport { AppMetadata, DevMetadata, Platform } from \"./metadata\"\nimport { PackagerOptions, PlatformPackager, BuildInfo, ArtifactCreated } from \"./platformPackager\"\nimport OsXPackager from \"./osxPackager\"\nimport { WinPackager } from \"./winPackager\"\nimport * as errorMessages from \"./errorMessages\"\nimport * as util from \"util\"\nimport deepAssign = require(\"deep-assign\")\n\n//noinspection JSUnusedLocalSymbols\nconst __awaiter = require(\"./awaiter\")\n\nfunction addHandler(emitter: EventEmitter, event: string, handler: Function) {\n  emitter.on(event, handler)\n}\n\nexport class Packager implements BuildInfo {\n  readonly projectDir: string\n  appDir: string\n\n  metadata: AppMetadata\n  devMetadata: DevMetadata\n\n  private isTwoPackageJsonProjectLayoutUsed = true\n\n  electronVersion: string\n\n  readonly eventEmitter = new EventEmitter()\n\n  //noinspection JSUnusedGlobalSymbols\n  constructor(public options: PackagerOptions, public repositoryInfo: InfoRetriever = null) {\n    this.projectDir = options.projectDir == null ? process.cwd() : path.resolve(options.projectDir)\n  }\n\n  artifactCreated(handler: (event: ArtifactCreated) => void): Packager {\n    addHandler(this.eventEmitter, \"artifactCreated\", handler)\n    return this\n  }\n\n  get devPackageFile(): string {\n    return path.join(this.projectDir, \"package.json\")\n  }\n\n  async build(): Promise<any> {\n    const devPackageFile = this.devPackageFile\n    const platforms = this.options.platform\n\n    this.devMetadata = deepAssign(await readPackageJson(devPackageFile), this.options.devMetadata)\n    this.appDir = await computeDefaultAppDirectory(this.projectDir, use(this.devMetadata.directories, it => it.app) || this.options.appDir)\n\n    this.isTwoPackageJsonProjectLayoutUsed = this.appDir !== this.projectDir\n\n    const appPackageFile = this.projectDir === this.appDir ? devPackageFile : path.join(this.appDir, \"package.json\")\n    this.metadata = appPackageFile === devPackageFile ? this.devMetadata : await readPackageJson(appPackageFile)\n    this.checkMetadata(appPackageFile, devPackageFile, platforms)\n    checkConflictingOptions(this.devMetadata.build)\n\n    this.electronVersion = await getElectronVersion(this.devMetadata, devPackageFile)\n\n    const cleanupTasks: Array<() => Promise<any>> = []\n    return executeFinally(this.doBuild(platforms, cleanupTasks), () => all(cleanupTasks.map(it => it())))\n  }\n\n  private async doBuild(platforms: Array<Platform>, cleanupTasks: Array<() => Promise<any>>): Promise<any> {\n    const distTasks: Array<Promise<any>> = []\n    const outDir = path.resolve(this.projectDir, use(this.devMetadata.directories, it => it.output) || \"dist\")\n\n    for (let platform of platforms) {\n      const helper = this.createHelper(platform, cleanupTasks)\n      for (let arch of normalizeArchs(platform, this.options.arch)) {\n        await this.installAppDependencies(platform, arch)\n        // electron-packager uses productName in the directory name\n        await helper.pack(outDir, arch, distTasks)}\n    }\n\n    return await BluebirdPromise.all(distTasks)\n  }\n\n  private createHelper(platform: Platform, cleanupTasks: Array<() => Promise<any>>): PlatformPackager<any> {\n    if (this.options.platformPackagerFactory != null) {\n      return this.options.platformPackagerFactory(this,  platform, cleanupTasks)\n    }\n\n    switch (platform) {\n      case Platform.OSX:\n      {\n        const helperClass: typeof OsXPackager = require(\"./osxPackager\").default\n        return new helperClass(this, cleanupTasks)\n      }\n\n      case Platform.WINDOWS:\n      {\n        const helperClass: typeof WinPackager = require(\"./winPackager\").WinPackager\n        return new helperClass(this, cleanupTasks)\n      }\n\n      case Platform.LINUX:\n        return new (require(\"./linuxPackager\").LinuxPackager)(this)\n\n      default:\n        throw new Error(\"Unknown platform: \" + platform)\n    }\n  }\n\n  private checkMetadata(appPackageFile: string, devAppPackageFile: string, platforms: Array<Platform>): void {\n    const reportError = (missedFieldName: string) => {\n      throw new Error(\"Please specify '\" + missedFieldName + \"' in the application package.json ('\" + appPackageFile + \"')\")\n    }\n\n    const appMetadata = this.metadata\n    if (appMetadata.name == null) {\n      reportError(\"name\")\n    }\n    else if (appMetadata.description == null) {\n      reportError(\"description\")\n    }\n    else if (appMetadata.version == null) {\n      reportError(\"version\")\n    }\n    else if ((<any>appMetadata) !== this.devMetadata) {\n      if ((<any>appMetadata).build != null) {\n        throw new Error(util.format(errorMessages.buildInAppSpecified, appPackageFile, devAppPackageFile))\n      }\n\n      if (this.devMetadata.homepage != null) {\n        warn(\"homepage in the development package.json is deprecated, please move to the application package.json\")\n      }\n      if (this.devMetadata.license != null) {\n        warn(\"license in the development package.json is deprecated, please move to the application package.json\")\n      }\n    }\n\n    if (this.devMetadata.build == null) {\n      throw new Error(util.format(errorMessages.buildIsMissed, devAppPackageFile))\n    }\n    else {\n      const author = appMetadata.author\n      if (author == null) {\n        reportError(\"author\")\n      }\n      else if (this.options.dist && author.email == null && platforms.includes(Platform.LINUX)) {\n        throw new Error(util.format(errorMessages.authorEmailIsMissed, appPackageFile))\n      }\n    }\n  }\n\n  private installAppDependencies(platform: Platform, arch: string): Promise<any> {\n    if (this.isTwoPackageJsonProjectLayoutUsed) {\n      if (platform.nodeName === process.platform) {\n        return installDependencies(this.appDir, this.electronVersion, arch, \"rebuild\")\n      }\n      else {\n        log(\"Skip app dependencies rebuild because platform is different\")\n      }\n    }\n    else {\n      log(\"Skip app dependencies rebuild because dev and app dependencies are not separated\")\n    }\n\n    return BluebirdPromise.resolve()\n  }\n}\n\nexport function normalizeArchs(platform: Platform, arch?: string) {\n  if (platform === Platform.OSX) {\n    return [\"x64\"]\n  }\n  else {\n    return arch == null ? [process.arch] : (arch === \"all\" ? [\"ia32\", \"x64\"] : [arch])\n  }\n}\n\nexport function normalizePlatforms(platforms: Array<string | Platform>): Array<Platform> {\n  if (platforms == null || platforms.length === 0) {\n    return [Platform.fromString(process.platform)]\n  }\n  else if (platforms[0] === \"all\") {\n    if (process.platform === Platform.OSX.nodeName) {\n      return [Platform.OSX, Platform.LINUX, Platform.WINDOWS]\n    }\n    else if (process.platform === Platform.LINUX.nodeName) {\n      // OS X code sign works only on OS X\n      return [Platform.LINUX, Platform.WINDOWS]\n    }\n    else {\n      return [Platform.WINDOWS]\n    }\n  }\n  else {\n    return platforms.map(it => it instanceof Platform ? it : Platform.fromString(it))\n  }\n}\n\nfunction checkConflictingOptions(options: any) {\n  for (let name of [\"all\", \"out\", \"tmpdir\", \"version\", \"platform\", \"dir\", \"arch\"]) {\n    if (name in options) {\n      throw new Error(`Option ${name} is ignored, do not specify it.`)\n    }\n  }\n}"
  ]
}
